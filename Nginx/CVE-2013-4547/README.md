# Nginx 파일 이름 로직 취약점（CVE-2013-4547）



### 요약

-   Nginx는 리버스 프록시 사이트에서 일부 파일을 캐싱, 특히 정적 파일을 캐싱
    -   이 캐시의 일부는 파일에 저장되며, 각 캐시 파일에는 "파일 헤더", "HTTP 응답 헤더", "HTTP 응답 본문"이 포함
-   요청에 Range 헤더가 포함되면 Nginx는 지정된 시작 및 종료 위치에 따라 지정된 길이의 내용을 반환
    -   두 개의 음수 위치를 구성하면, 예를 들어 (-600, -9223372036854774591), 음수 위치의 데이터를 읽을 수 있음
-   이 요청이 캐시 파일에 일치하면 캐시 파일 내의 "HTTP 응답 본문" 앞에 있는 "파일 헤더", "HTTP 응답 헤더" 등의 내용을 읽을 수 있음

<br/>

```
location ~ \.php$ {
    include        fastcgi_params;

    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  /var/www/html$fastcgi_script_name;
    fastcgi_param  DOCUMENT_ROOT /var/www/html;
}
```

正常情况下（关闭pathinfo的情况下），只有.php后缀的文件才会被发送给fastcgi解析。

而存在CVE-2013-4547的情况下，我们请求`1.gif[0x20][0x00].php`，这个URI可以匹配上正则`\.php$`，可以进入这个Location块；但进入后，Nginx却错误地认为请求的文件是`1.gif[0x20]`，就设置其为`SCRIPT_FILENAME`的值发送给fastcgi。

fastcgi根据`SCRIPT_FILENAME`的值进行解析，最后造成了解析漏洞。

所以，我们只需要上传一个空格结尾的文件，即可使PHP解析之。

再举个例子，比如很多网站限制了允许访问后台的IP：

```
location /admin/ {
    allow 127.0.0.1;
    deny all;
}
```

我们可以请求如下URI：`/test[0x20]/../admin/index.php`，这个URI不会匹配上location后面的`/admin/`，也就绕过了其中的IP验证；但最后请求的是`/test[0x20]/../admin/index.php`文件，也就是`/admin/index.php`，成功访问到后台。（这个前提是需要有一个目录叫`test `：这是Linux系统的特点，如果有一个不存在的目录，则即使跳转到上一层，也会爆文件不存在的错误，Windows下没有这个限制）

### 환경 구성 및 실행

-   `docker compose up -d`를 실행하여 테스트 환경을 실행
-   `http://your-ip:8070/`에 접속하여 Nginx 기본 페이지를 확인
    -   이 페이지는 실제로 8081 포트의 내용을 리버스 프록시로 전달
-   `exploit.jpg` 파일을 업로드 하였습니다. 
    -   업로드된 위치/exploit.jpg.php에서 헤더값을 수정하여 php파일 실행 시킬 수 있었습니다.

<br/>
### 결과

![](result.png)

<br/>

### 정리

  이 취약점은 서버에서 php파일 업로드를 제한하였을경우 jpg파일로 위장하여 php파일 업로드 후 해당 업로드 위치에서 php파일을 동작시키는 위험이 있습니다. 
  안전한 웹 서비스 운영을 위해 이러한 취약점을 패치하기 위하여 업로드 위치를 알려주어서는 안되며 해당 취약점이 패치된 최신 NginX를 사용하여야 합니다.
